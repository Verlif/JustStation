# 权限

JustStation使用的是Spring提供的AOP方式进行的权限校验，主要的类为`PermissionHandler`、`PermissionDetector`与`PermissionMapper`

## 1. 使用

`PermissionHandler`拦截了被`Perm`注解标记的方法，随后根据注解说明的判定方式，对已登陆用户的权限进行检测。未登录时会抛出未登录异常。
`Perm`注解用于API接口上或是`Controller`类上，例如用在API接口方法上来限定API使用，或是标记在文件获取方法上限定文件获取等。

```java
    /**
     * 注册方法开放，不设权限
     */
    @Operation(summary = "注册")
    @PostMapping("/register")
    public BaseResult<?> register(
            @RequestBody @Validated(Insert.class) User user
    ) {
        return userBiz.register(user);
    }

    /**
     * 获取个人信息时，需要登录用户
     */
    @Perm(hasRole = "user")
    @Operation(summary = "获取个人信息")
    @GetMapping("/self")
    public BaseResult<?> selfInfo() {
        return userBiz.getSelfInfo();
    }
```

## 2. 实现`PermissionMapper`

`PermissionMapper`的作用是获取每个用户的权限，在内置方案中，每个用户在每次登录成功后就会获取一次，也就是只有在登录是才会调用，并将用户权限数据注入`LoginUser`中，用于`PermissionDetector`的判定。

```java
    public interface PermissionMapper {

        /**
        * 通过用户名标识获取角色组
        *
        * @param username 用户名
        * @return 用户所在的角色组
        */
        Set<String> getUserRoleSet(String username);

        /**
        * 通过用户名标识获取关键词组
        *
        * @param username 用户名
        * @return 用户所在的关键词组
        */
        Set<String> getUserKeySet(String username);
    }
```

## 3. 实现`PermissionDetector`

`PermissionDetector`用于做权限判定，内置的实现类是利用的登录用户信息中的角色列表与权限Key列表来做的判定，开发者也可以自行实现方法。
自定义`PermissionDetector`时，只需要实现`PermissionDetector`接口，并使用`Component`注解注入即可。

```java
    public interface PermissionDetector {

        /**
        * 是否拥有角色
        *
        * @param role 角色名称
        * @return true - 拥有；false - 未拥有
        */
        boolean hasRole(String role);

        /**
        * 是否拥有关键词
        *
        * @param key 关键词
        * @return true - 拥有；false - 未拥有
        */
        boolean hasKey(String key);

        /**
        * 与{@code hasRole(String)}方法相反
        *
        * @param role 角色名称
        * @return true - 没有；false - 拥有
        * @see PermissionDetector#hasRole(String)
        */
        default boolean noRole(String role) {
            return !hasRole(role);
        }

        /**
        * 与{@code hasKey(String)}方法相反
        *
        * @param key 关键词
        * @return true - 没有；false - 拥有
        * @see PermissionDetector#hasKey(String)
        */
        default boolean noKey(String key) {
            return !hasKey(key);
        }
    }
```